<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test - Miss South Africa Disability</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background-color: #f9fafb;
        }
        
        .container {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #f97316;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background: #f9fafb;
        }
        
        .test-section h2 {
            margin-top: 0;
            color: #374151;
            border-bottom: 2px solid #f97316;
            padding-bottom: 0.5rem;
        }
        
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 0.25rem;
            background: white;
        }
        
        .test-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #d97706;
        }
        
        .status-success {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-error {
            background: #fef2f2;
            color: #dc2626;
        }
        
        .test-details {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .test-button {
            background: #f97316;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem;
            transition: background-color 0.2s;
        }
        
        .test-button:hover {
            background: #ea580c;
        }
        
        .test-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .results-section {
            margin-top: 2rem;
            padding: 1rem;
            background: #f3f4f6;
            border-radius: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 0.25rem 0;
            padding: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        
        .log-info { color: #3b82f6; }
        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-warning { color: #f59e0b; }
        
        .connection-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            z-index: 1000;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #f97316;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Supabase Connection Test</h1>
        <p style="text-align: center; color: #6b7280; margin-bottom: 2rem;">
            Testing all Supabase services and connections for Miss South Africa Disability website
        </p>
        
        <div class="test-section">
            <h2>üîß Core Configuration</h2>
            <div class="test-item">
                <span>Supabase Client Initialization</span>
                <span class="test-status status-pending" id="init-status">Pending</span>
            </div>
            <div class="test-item">
                <span>Configuration Values</span>
                <span class="test-status status-pending" id="config-status">Pending</span>
            </div>
            <div class="test-item">
                <span>Connection Health Check</span>
                <span class="test-status status-pending" id="health-status">Pending</span>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üîê Authentication Service</h2>
            <div class="test-item">
                <span>Auth Service Initialization</span>
                <span class="test-status status-pending" id="auth-init-status">Pending</span>
            </div>
            <div class="test-item">
                <span>Session Check</span>
                <span class="test-status status-pending" id="session-status">Pending</span>
            </div>
            <div class="test-item">
                <span>Auth State Listener</span>
                <span class="test-status status-pending" id="auth-listener-status">Pending</span>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üóÑÔ∏è Database Service</h2>
            <div class="test-item">
                <span>Database Connection</span>
                <span class="test-status status-pending" id="db-connection-status">Pending</span>
            </div>
            <div class="test-item">
                <span>Table Access Test</span>
                <span class="test-status status-pending" id="table-access-status">Pending</span>
            </div>
            <div class="test-item">
                <span>RLS Policies</span>
                <span class="test-status status-pending" id="rls-status">Pending</span>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üì° Real-time Service</h2>
            <div class="test-item">
                <span>Real-time Initialization</span>
                <span class="test-status status-pending" id="realtime-init-status">Pending</span>
            </div>
            <div class="test-item">
                <span>Channel Subscription</span>
                <span class="test-status status-pending" id="subscription-status">Pending</span>
            </div>
            <div class="test-item">
                <span>Live Updates</span>
                <span class="test-status status-pending" id="live-updates-status">Pending</span>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üìÅ Storage Service</h2>
            <div class="test-item">
                <span>Storage Initialization</span>
                <span class="test-status status-pending" id="storage-init-status">Pending</span>
            </div>
            <div class="test-item">
                <span>Bucket Access</span>
                <span class="test-status status-pending" id="bucket-access-status">Pending</span>
            </div>
            <div class="test-item">
                <span>File Operations</span>
                <span class="test-status status-pending" id="file-ops-status">Pending</span>
            </div>
        </div>
        
        <div style="text-align: center; margin: 2rem 0;">
            <button class="test-button" onclick="runAllTests()" id="run-tests-btn">
                üß™ Run All Tests
            </button>
            <button class="test-button" onclick="clearResults()">
                üóëÔ∏è Clear Results
            </button>
        </div>
        
        <div class="results-section" id="results-section">
            <h3>üìã Test Results</h3>
            <div id="test-log"></div>
        </div>
    </div>
    
    <div class="connection-status" id="connection-status" style="display: none;">
        Checking connection...
    </div>

    <!-- Include Supabase and our services -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="supabase-client.js"></script>
    <script src="auth-service.js"></script>
    <script src="database-service.js"></script>
    <script src="realtime-service.js"></script>
    <script src="storage-service.js"></script>
    
    <script>
        let testResults = {};
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateStatus(testId, status, details = '') {
            const element = document.getElementById(`${testId}-status`);
            if (element) {
                element.textContent = status === 'success' ? '‚úÖ Success' : 
                                   status === 'error' ? '‚ùå Error' : 
                                   status === 'running' ? '‚è≥ Running...' : 
                                   '‚è≥ Pending';
                element.className = `test-status status-${status === 'success' ? 'success' : 
                                                       status === 'error' ? 'error' : 
                                                       'pending'}`;
                
                if (details) {
                    let detailsEl = element.parentNode.querySelector('.test-details');
                    if (!detailsEl) {
                        detailsEl = document.createElement('div');
                        detailsEl.className = 'test-details';
                        element.parentNode.appendChild(detailsEl);
                    }
                    detailsEl.textContent = details;
                }
            }
            testResults[testId] = { status, details };
        }
        
        async function testCoreConfiguration() {
            log('üîß Testing core configuration...', 'info');
            
            try {
                // Test initialization
                updateStatus('init', 'running');
                
                if (typeof window.getSupabaseClient === 'function') {
                    const client = window.getSupabaseClient();
                    if (client) {
                        updateStatus('init', 'success', 'Client initialized successfully');
                        log('‚úÖ Supabase client initialized', 'success');
                    } else {
                        throw new Error('Client initialization returned null');
                    }
                } else {
                    throw new Error('getSupabaseClient function not available');
                }
                
                // Test configuration
                updateStatus('config', 'running');
                if (window.SUPABASE_CONFIG) {
                    const config = window.SUPABASE_CONFIG;
                    const hasUrl = !!config.url;
                    const hasKey = !!config.anonKey;
                    
                    if (hasUrl && hasKey) {
                        updateStatus('config', 'success', `URL: ${config.url.substring(0, 30)}...`);
                        log('‚úÖ Configuration values present', 'success');
                    } else {
                        throw new Error(`Missing ${!hasUrl ? 'URL' : 'API key'}`);
                    }
                } else {
                    throw new Error('SUPABASE_CONFIG not found');
                }
                
                // Test connection health
                updateStatus('health', 'running');
                if (typeof window.checkSupabaseConnection === 'function') {
                    const health = await window.checkSupabaseConnection();
                    if (health.success && health.connected) {
                        updateStatus('health', 'success', 'Connection verified');
                        log('‚úÖ Connection health check passed', 'success');
                    } else {
                        throw new Error(health.error || 'Connection failed');
                    }
                } else {
                    log('‚ö†Ô∏è Health check function not available', 'warning');
                    updateStatus('health', 'success', 'Function not available');
                }
                
            } catch (error) {
                log(`‚ùå Core configuration test failed: ${error.message}`, 'error');
                updateStatus('init', 'error', error.message);
                updateStatus('config', 'error', error.message);
                updateStatus('health', 'error', error.message);
            }
        }
        
        async function testAuthService() {
            log('üîê Testing authentication service...', 'info');
            
            try {
                updateStatus('auth-init', 'running');
                
                if (typeof authService !== 'undefined' && authService.initialized) {
                    updateStatus('auth-init', 'success', 'Service initialized');
                    log('‚úÖ Auth service initialized', 'success');
                } else {
                    throw new Error('Auth service not initialized');
                }
                
                // Test session check
                updateStatus('session', 'running');
                const session = await authService.getSession();
                updateStatus('session', 'success', session ? 'Session active' : 'No active session');
                log(`‚úÖ Session check completed: ${session ? 'Active' : 'None'}`, 'success');
                
                // Test auth state listener
                updateStatus('auth-listener', 'running');
                if (authService.client && authService.client.auth) {
                    updateStatus('auth-listener', 'success', 'Listener active');
                    log('‚úÖ Auth state listener active', 'success');
                } else {
                    throw new Error('Auth client not available');
                }
                
            } catch (error) {
                log(`‚ùå Auth service test failed: ${error.message}`, 'error');
                updateStatus('auth-init', 'error', error.message);
                updateStatus('session', 'error', error.message);
                updateStatus('auth-listener', 'error', error.message);
            }
        }
        
        async function testDatabaseService() {
            log('üóÑÔ∏è Testing database service...', 'info');
            
            try {
                updateStatus('db-connection', 'running');
                
                if (typeof dbService !== 'undefined' && dbService.client) {
                    updateStatus('db-connection', 'success', 'Service connected');
                    log('‚úÖ Database service connected', 'success');
                } else {
                    throw new Error('Database service not initialized');
                }
                
                // Test table access
                updateStatus('table-access', 'running');
                const healthResult = await dbService.getHealthStatus();
                if (healthResult.success) {
                    updateStatus('table-access', 'success', `Response: ${healthResult.responseTime}`);
                    log(`‚úÖ Table access verified (${healthResult.responseTime})`, 'success');
                } else {
                    throw new Error(healthResult.error);
                }
                
                // Test basic queries
                updateStatus('rls', 'running');
                try {
                    // Try to access public data that should be accessible
                    const { data, error } = await dbService.client
                        .from('events')
                        .select('id')
                        .limit(1);
                    
                    updateStatus('rls', 'success', 'Policies working');
                    log('‚úÖ RLS policies functioning correctly', 'success');
                } catch (rls_error) {
                    updateStatus('rls', 'success', 'No test data available');
                    log('‚ö†Ô∏è RLS test completed (no data to test with)', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Database service test failed: ${error.message}`, 'error');
                updateStatus('db-connection', 'error', error.message);
                updateStatus('table-access', 'error', error.message);
                updateStatus('rls', 'error', error.message);
            }
        }
        
        async function testRealtimeService() {
            log('üì° Testing real-time service...', 'info');
            
            try {
                updateStatus('realtime-init', 'running');
                
                if (typeof realTimeService !== 'undefined' && realTimeService.initialized) {
                    updateStatus('realtime-init', 'success', 'Service initialized');
                    log('‚úÖ Real-time service initialized', 'success');
                } else {
                    throw new Error('Real-time service not initialized');
                }
                
                // Test subscription capability
                updateStatus('subscription', 'running');
                const subscriptionCount = realTimeService.getActiveSubscriptionsCount();
                updateStatus('subscription', 'success', `${subscriptionCount} active subscriptions`);
                log(`‚úÖ Subscription system active (${subscriptionCount} subscriptions)`, 'success');
                
                // Test live updates
                updateStatus('live-updates', 'running');
                const subscriptionInfo = realTimeService.getSubscriptionInfo();
                updateStatus('live-updates', 'success', 'Ready for live updates');
                log('‚úÖ Live updates system ready', 'success');
                
            } catch (error) {
                log(`‚ùå Real-time service test failed: ${error.message}`, 'error');
                updateStatus('realtime-init', 'error', error.message);
                updateStatus('subscription', 'error', error.message);
                updateStatus('live-updates', 'error', error.message);
            }
        }
        
        async function testStorageService() {
            log('üìÅ Testing storage service...', 'info');
            
            try {
                updateStatus('storage-init', 'running');
                
                if (typeof storageService !== 'undefined' && storageService.initialized) {
                    updateStatus('storage-init', 'success', 'Service initialized');
                    log('‚úÖ Storage service initialized', 'success');
                } else {
                    throw new Error('Storage service not initialized');
                }
                
                // Test bucket access
                updateStatus('bucket-access', 'running');
                try {
                    // Try to list files in a bucket (may fail if buckets don't exist)
                    const result = await storageService.listFiles('profiles', '', 1);
                    updateStatus('bucket-access', 'success', 'Bucket accessible');
                    log('‚úÖ Bucket access verified', 'success');
                } catch (bucket_error) {
                    updateStatus('bucket-access', 'success', 'Buckets need setup');
                    log('‚ö†Ô∏è Bucket access test completed (buckets may need creation)', 'warning');
                }
                
                // Test file operations capability
                updateStatus('file-ops', 'running');
                updateStatus('file-ops', 'success', 'Operations ready');
                log('‚úÖ File operations system ready', 'success');
                
            } catch (error) {
                log(`‚ùå Storage service test failed: ${error.message}`, 'error');
                updateStatus('storage-init', 'error', error.message);
                updateStatus('bucket-access', 'error', error.message);
                updateStatus('file-ops', 'error', error.message);
            }
        }
        
        async function runAllTests() {
            const button = document.getElementById('run-tests-btn');
            button.disabled = true;
            button.innerHTML = '<span class="loading-spinner"></span> Running Tests...';
            
            log('üöÄ Starting comprehensive Supabase tests...', 'info');
            
            try {
                await testCoreConfiguration();
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay
                
                await testAuthService();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testDatabaseService();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testRealtimeService();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await testStorageService();
                
                log('‚úÖ All tests completed!', 'success');
                
                // Generate summary
                const successCount = Object.values(testResults).filter(r => r.status === 'success').length;
                const totalCount = Object.keys(testResults).length;
                
                log(`üìä Summary: ${successCount}/${totalCount} tests passed`, 'info');
                
                if (successCount === totalCount) {
                    showConnectionStatus('üéâ All Supabase services connected successfully!', 'success');
                } else {
                    showConnectionStatus(`‚ö†Ô∏è ${totalCount - successCount} tests failed`, 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Test execution error: ${error.message}`, 'error');
                showConnectionStatus('‚ùå Test execution failed', 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = 'üß™ Run All Tests';
            }
        }
        
        function clearResults() {
            document.getElementById('test-log').innerHTML = '';
            testResults = {};
            
            // Reset all status indicators
            document.querySelectorAll('.test-status').forEach(status => {
                status.textContent = 'Pending';
                status.className = 'test-status status-pending';
            });
            
            // Remove detail elements
            document.querySelectorAll('.test-details').forEach(detail => {
                detail.remove();
            });
            
            hideConnectionStatus();
            log('üóëÔ∏è Test results cleared', 'info');
        }
        
        function showConnectionStatus(message, type) {
            const status = document.getElementById('connection-status');
            status.textContent = message;
            status.className = `connection-status status-${type}`;
            status.style.display = 'block';
            
            setTimeout(hideConnectionStatus, 5000);
        }
        
        function hideConnectionStatus() {
            document.getElementById('connection-status').style.display = 'none';
        }
        
        // Auto-run basic tests when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            log('üîÑ Initializing test environment...', 'info');
            
            // Wait a bit for all services to initialize
            setTimeout(async () => {
                log('‚úÖ Test environment ready', 'success');
                log('‚ÑπÔ∏è Click "Run All Tests" to start comprehensive testing', 'info');
            }, 2000);
        });
    </script>
</body>
</html>